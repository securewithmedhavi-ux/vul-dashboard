<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vulnerability Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { padding: 8px 10px; border: 1px solid #ddd; text-align: left; font-size: 14px; }
    th { background: #f4f4f4; }
    #charts { display:flex; gap: 20px; margin-top: 12px; }
    .chart { flex: 1; min-width: 300px; height: 350px; }
  </style>
</head>
<body>
  <h1>Vulnerability Dashboard</h1>
  <p>Shows recent Nmap scan results stored in <code>vulns.db</code>.</p>

  <div id="charts">
    <div id="stateChart" class="chart"></div>
    <div id="serviceChart" class="chart"></div>
  </div>

  <h2>Recent findings</h2>
  <table id="results">
    <thead>
      <tr><th>ID</th><th>Target</th><th>Port</th><th>Service</th><th>State</th><th>Timestamp</th></tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
async function fetchData() {
  const [rowsResp, chartResp] = await Promise.all([
    fetch('/api/rows'), fetch('/api/chart-data')
  ]);
  const rows = await rowsResp.json();
  const chartData = await chartResp.json();

  // fill table
  const tbody = document.querySelector('#results tbody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.id}</td><td>${r.target}</td><td>${r.port ?? ''}</td><td>${r.service}</td><td>${r.state}</td><td>${r.timestamp}</td>`;
    tbody.appendChild(tr);
  });

  // state chart (bar)
  const stateTrace = { x: chartData.state.labels, y: chartData.state.values, type: 'bar' };
  Plotly.newPlot('stateChart', [stateTrace], { title: 'Count by State' });

  // service chart (bar)
  const svcTrace = { x: chartData.service.labels, y: chartData.service.values, type: 'bar' };
  Plotly.newPlot('serviceChart', [svcTrace], { title: 'Top Services' });
}

fetchData();

// auto-refresh every 60s
setInterval(fetchData, 60000);
</script>
</body>
</html>