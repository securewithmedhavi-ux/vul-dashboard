<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vulnerability Dashboard</title>

  <!-- Bootstrap & Chart Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(120deg, #0f172a, #1e293b);
      color: #e2e8f0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    h1 {
      text-align: center;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: #f8fafc;
      margin-bottom: 2rem;
    }

    .glass {
      background: rgba(255, 255, 255, 0.04);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
      transition: transform 0.25s ease;
    }

    .glass:hover {
      transform: translateY(-4px);
    }

    .metric-card h5 {
      font-weight: 500;
      color: #94a3b8;
      font-size: 0.95rem;
    }

    .metric-card h2 {
      font-weight: 600;
      color: #f1f5f9;
    }

    .table {
      color: #e2e8f0;
    }

    .table thead {
      color: #94a3b8;
    }

    .chart-container {
      height: 300px;
    }

    footer {
      text-align: center;
      color: #64748b;
      margin-top: 3rem;
      font-size: 0.85rem;
    }
  </style>
</head>

<body>
  <div class="container-fluid py-4 px-4">
    <h1>Network Vulnerability Dashboard</h1>

    <!-- Metrics -->
    <div class="row g-4 mb-4 text-center">
      <div class="col-md-3">
        <div class="glass p-3 metric-card">
          <h5>Total Hosts</h5>
          <h2 id="total-hosts">0</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="glass p-3 metric-card">
          <h5>Open Ports</h5>
          <h2 id="open-ports">0</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="glass p-3 metric-card">
          <h5>Filtered Ports</h5>
          <h2 id="filtered-ports">0</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="glass p-3 metric-card">
          <h5>Last Scan</h5>
          <h2 id="last-scan">--</h2>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="glass p-4">
          <h6 class="text-secondary mb-3">Port Status Overview</h6>
          <div id="port-status-chart" class="chart-container"></div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="glass p-4">
          <h6 class="text-secondary mb-3">Top Services</h6>
          <canvas id="service-chart" class="chart-container"></canvas>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="glass p-4">
          <h6 class="text-secondary mb-3">Recent Scan Results</h6>
          <div class="table-responsive">
            <table class="table table-dark table-hover align-middle small">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Target</th>
                  <th>Port</th>
                  <th>Service</th>
                  <th>State</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody id="data-table"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <footer>© 2025 SecureWithMedhavi — Built with Flask & Chart.js</footer>
  </div>

  <script>
    fetch('/api/rows')
      .then(res => res.json())
      .then(data => {
        // Summary Cards
        const open = data.filter(d => d.state === 'open').length;
        const filtered = data.filter(d => d.state === 'filtered').length;
        const hosts = [...new Set(data.map(d => d.target))].length;
        const lastScan = data[0]?.timestamp || '--';
        document.getElementById('total-hosts').textContent = hosts;
        document.getElementById('open-ports').textContent = open;
        document.getElementById('filtered-ports').textContent = filtered;
        document.getElementById('last-scan').textContent = lastScan;

        // Table
        const tbody = document.getElementById('data-table');
        tbody.innerHTML = data.map(d => `
          <tr>
            <td>${d.id}</td>
            <td>${d.target}</td>
            <td>${d.port}</td>
            <td>${d.service}</td>
            <td>${d.state}</td>
            <td>${d.timestamp}</td>
          </tr>
        `).join('');

        // Pie Chart (Plotly)
        const stateCounts = {};
        data.forEach(d => stateCounts[d.state] = (stateCounts[d.state] || 0) + 1);
        const pieData = [{
          values: Object.values(stateCounts),
          labels: Object.keys(stateCounts),
          type: 'pie',
          marker: { colors: ['#60a5fa', '#94a3b8', '#f87171'] },
          textinfo: 'label+percent',
          hole: 0.4
        }];
        const pieLayout = {
          paper_bgcolor: 'transparent',
          font: { color: '#cbd5e1' },
          height: 300
        };
        Plotly.newPlot('port-status-chart', pieData, pieLayout);

        // Bar Chart (Chart.js)
        const serviceCounts = {};
        data.forEach(d => serviceCounts[d.service] = (serviceCounts[d.service] || 0) + 1);
        const ctx = document.getElementById('service-chart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(serviceCounts).slice(0, 10),
            datasets: [{
              label: 'Occurrences',
              data: Object.values(serviceCounts).slice(0, 10),
              backgroundColor: 'rgba(96,165,250,0.7)',
              borderColor: '#3b82f6',
              borderWidth: 1,
              borderRadius: 6
            }]
          },
          options: {
            scales: {
              x: { ticks: { color: '#94a3b8' } },
              y: { ticks: { color: '#94a3b8' } }
            },
            plugins: {
              legend: { labels: { color: '#94a3b8' } }
            }
          }
        });
      });
  </script>
</body>
</html>
